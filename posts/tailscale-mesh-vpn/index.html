<!doctype html><html lang=en><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><style>:root{--accent-color:#c40000}</style><title>Tailscale Mesh VPN</title>
<meta name=description content="On a quest to serve."><meta name=keywords content="blog,gokarna,hugo,devops,tech,documentation,sysadmin,opensource,how-to,IT,software,VPN,homelab,tailscale,network,docker"><meta property="og:url" content="https://knightsdata.com/posts/tailscale-mesh-vpn/"><meta property="og:type" content="website"><meta property="og:title" content="Tailscale Mesh VPN"><meta property="og:description" content="On a quest to serve."><meta property="og:image" content="/images/avatar.jpg"><meta name=twitter:card content="summary_large_image"><meta name=twitter:title content="Tailscale Mesh VPN"><meta name=twitter:description content="On a quest to serve."><meta property="twitter:domain" content="https://knightsdata.com/posts/tailscale-mesh-vpn/"><meta property="twitter:url" content="https://knightsdata.com/posts/tailscale-mesh-vpn/"><meta name=twitter:image content="/images/avatar.jpg"><link rel=canonical href=https://knightsdata.com/posts/tailscale-mesh-vpn/><link rel=stylesheet type=text/css href=https://knightsdata.com/css/normalize.min.css media=print onload='this.media="all"'><link rel=stylesheet type=text/css href=https://knightsdata.com/css/main.css><link disabled id=dark-theme rel=stylesheet href=https://knightsdata.com/css/dark.css><script src=https://knightsdata.com/js/svg-injector.min.js></script><script src=https://knightsdata.com/js/feather-icons.min.js></script><script src=https://knightsdata.com/js/main.js></script><link rel=stylesheet href=/css/custom.css></head><body><script type=text/javascript>setThemeByUserPref()</script><header class=header><nav class=header-nav><div class=avatar><a href=https://knightsdata.com><img src=https://knightsdata.com/images/avatar.jpg alt=avatar></a></div><div class=nav-title><a class=nav-brand href=https://knightsdata.com>knightsdata</a></div><div class=nav-links><div class=nav-link><a href=https://knightsdata.com/posts/>Blog</a></div><div class=nav-link><a href=https://knightsdata.com/tags/>Tags</a></div><div class=nav-link><a href=https://knightsdata.com/about/>About</a></div><div class=nav-link><a href=https://github.com/radarsymphony><span data-feather=github></span></a></div><span class=nav-icons-divider></span><div class="nav-link dark-theme-toggle"><span id=dark-theme-toggle-screen-reader-target class=sr-only></span>
<a><span id=theme-toggle-icon data-feather=moon></span></a></div><div class=nav-link id=hamburger-menu-toggle><span id=hamburger-menu-toggle-screen-reader-target class=sr-only>menu</span>
<a><span data-feather=menu></span></a></div><ul class="nav-hamburger-list visibility-hidden"><li class=nav-item><a href=https://knightsdata.com/posts/>Blog</a></li><li class=nav-item><a href=https://knightsdata.com/tags/>Tags</a></li><li class=nav-item><a href=https://knightsdata.com/about/>About</a></li><li class=nav-item><a href=https://github.com/radarsymphony><span data-feather=github></span></a></li><li class="nav-item dark-theme-toggle"><span id=dark-theme-toggle-screen-reader-target class=sr-only>theme</span>
<a><span id=theme-toggle-icon data-feather=moon></span></a></li></ul></div></nav></header><main id=content><div class="post container"><div class=post-header-section><h1>Tailscale Mesh VPN</h1><small role=doc-subtitle></small><p class=post-date>October 31, 2023</p><ul class=post-tags><li class=post-tag><a href=https://knightsdata.com/tags/vpn>VPN</a></li><li class=post-tag><a href=https://knightsdata.com/tags/homelab>homelab</a></li><li class=post-tag><a href=https://knightsdata.com/tags/tailscale>tailscale</a></li><li class=post-tag><a href=https://knightsdata.com/tags/network>network</a></li><li class=post-tag><a href=https://knightsdata.com/tags/docker>docker</a></li></ul></div><div class=post-content><p><h1 id=overview>Overview</h1><p><a href=https://tailscale.com/>Tailscale</a> is an easy to configure mesh VPN. It uses <a href=https://tailscale.com/blog/how-nat-traversal-works/>NAT traversal</a> to connect peers to each other. This article will outline the steps to set up Tailscale running in Docker as if it were running on the docker host directly (without SSH over the VPN - yet). This approach enables managing the Tailscale connection as you would any other docker service and creates a portable and deploy-able compose.yml to run on other systems.</p><h1 id=tailscale-account>Tailscale Account</h1><p>Tailscale makes use of a control panel to orchestrate and connect nodes. In order to connect your devices together, you need to create an account with Tailscale.</p><blockquote><p>In <a href=/posts/headscale-for-tailscale-vpn>this article</a>, I modify the VPN outlined here to move away from the closed source Tailscale control server to the opensource Headscale control server.</p></blockquote><ol><li>Create an account with Tailscale <a href=https://login.tailscale.com/>login.tailscale.com</a></li><li>Go to <strong>Settings</strong> > <strong>Personal Settings</strong> > <strong>Keys</strong></li><li>Click <strong>Generate auth key</strong>, turn on <strong>Reusable</strong></li><li>Click <strong>Generate key</strong> and save the value.</li></ol><h1 id=docker-compose>Docker Compose</h1><ol><li>Create a directory to host this service: <code>mkdir /srv/apps/tailscale</code></li><li>Change into that directory: <code>cd /srv/apps/tailscale</code></li><li>Create a compose.yml file: <code>touch compose.yml</code></li><li>Open the file up with an editor and paste in the following:</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>services</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>tailscale</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>image</span>: <span style=color:#ae81ff>tailscale/tailscale</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>container_name</span>: <span style=color:#ae81ff>tailscale</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>network_mode</span>: <span style=color:#e6db74>&#34;host&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>environment</span>:
</span></span><span style=display:flex><span>      - <span style=color:#ae81ff>TZ=[YOUR_TIMEZONE]</span>
</span></span><span style=display:flex><span>      - <span style=color:#ae81ff>TS_HOSTNAME=${HOSTNAME}-tailscale</span>
</span></span><span style=display:flex><span>      - <span style=color:#ae81ff>TS_AUTHKEY=[TS_AUTHKEY]</span>
</span></span><span style=display:flex><span>      - <span style=color:#ae81ff>TS_STATE_DIR=/tailscale/state</span>
</span></span><span style=display:flex><span>      - <span style=color:#ae81ff>TS_SOCKET=/var/run/tailscale/tailscaled.sock</span>
</span></span><span style=display:flex><span>      - <span style=color:#ae81ff>TS_TAILSCALED_EXTRA_ARGS=--tun=tailscale0</span> <span style=color:#75715e># important </span>
</span></span><span style=display:flex><span>      - <span style=color:#ae81ff>TS_DEBUG_FIREWALL_MODE=nftables</span>
</span></span><span style=display:flex><span>      - <span style=color:#ae81ff>TS_NO_LOGS_NO_SUPPORT=true</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>volumes</span>:
</span></span><span style=display:flex><span>      - <span style=color:#ae81ff>./data/tailscale/state:/tailscale/state</span>
</span></span><span style=display:flex><span>      - <span style=color:#ae81ff>/dev/net/tun:/dev/net/tun</span> <span style=color:#75715e># important</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>cap_add</span>:
</span></span><span style=display:flex><span>      - <span style=color:#ae81ff>net_admin</span>
</span></span><span style=display:flex><span>      - <span style=color:#ae81ff>sys_module</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>restart</span>: <span style=color:#ae81ff>unless-stopped</span>
</span></span></code></pre></div><ol start=5><li>Update the TS_AUTHKEY that you generated in the account.</li></ol><h1 id=start-tailscale>Start Tailscale</h1><ol><li>While logged in to the Tailscale control panel, go to <a href=https://login.tailscale.com/admin/machines>the machines tab</a>.</li><li>In your terminal at the Tailscale directory, run: <code>docker-compose up -d</code></li><li>Refresh the machines tab and you should see a new node appear.</li></ol><h1 id=testing>Testing</h1><p>A quick way to test if the VPN is working is to install the <a href=https://tailscale.com/downloads>Tailscale app on a mobile device</a>. You should be able to see both devices registered in your machine&rsquo;s tab in Tailscale.</p><h1 id=troubleshooting>Troubleshooting</h1><p>Start simple and progress in small steps. When I set this up, I started with installing the Tailscale binary on two servers (no Docker) exactly like the Tailscale documentation described. This approach allowed me to just see if the two hosts would be able to connect as intended before adding another layer of complexity. I then slowly transitioned one server to use Docker, then the other.</p><p>Oracle Cloud Free Tier allows the provision of a small VPS within minutes that can be useful for having another remote (plain/fresh) node to set up Tailscale on and test iterations.</p><p>I frequently ran <code>docker exec tailscale tailscale [status|ping &lt;tailscale-hostname>]</code> to see if the current node was registering other nodes and to gain insight into things like whether it was using IPv4 or IPv6.</p><p>I initially had issues with <a href=https://github.com/tailscale/tailscale/issues/5621>iptables vs nftables</a> and found that for my devices I had to set <code>TS_DEBUG_FIREWALL_MODE=nftables</code>. If you encounter issues, you can try removing this value.</p><p>To run Tailscale in Docker as if it were running on the host posed some challenges. The nodes were registering but not fully connecting to each other until I added <code>TS_TAILSCALED_EXTRA_ARGS=--tun=tailscale0</code>. By default, the <a href="https://tailscale.com/kb/1282/docker/?q=docker#ts_userspace">Tailscale Docker image enables &ldquo;userspace-networking&rdquo;</a> which doesn&rsquo;t seem to work in this setup.</p><p>Depending on your firewall, you may find pointers in the <a href=https://tailscale.com/kb/1181/firewalls/>Tailscale firewall documentation</a>.</p><p>If you have suggestions or would like another pair of eyes to toubleshoot, please reach out by opening an issue in the repo that tracks this website. You can find it here:</p><p><a href=https://github.com/radarsymphony/radarsymphony.github.io/issues>https://github.com/radarsymphony/radarsymphony.github.io/issues</a></p><h1 id=resources>Resources</h1><ul><li><a href=https://tailscale.com/kb/1155/terminology-and-concepts/>Tailscale Terminology and Concepts reference</a></li><li><a href=https://www.wundertech.net/how-to-set-up-tailscale-on-docker/>https://www.wundertech.net/how-to-set-up-tailscale-on-docker/</a></li><li><a href=https://docs.ibracorp.io/tailscale/tailscale/docker-compose>https://docs.ibracorp.io/tailscale/tailscale/docker-compose</a></li><li><a href=https://tailscale.dev/blog/docker-mod-tailscale>Similar approach but Tailscale within each docker container</a></li><li><a href=/posts/headscale-for-tailscale-vpn>Setting up Headscale to run in Docker behind Reverse Proxy</a></li></ul></p></div><div class=prev-next></div></div><aside class=post-toc><nav id=toc><nav id=TableOfContents><ul><li><a href=#overview>Overview</a></li><li><a href=#tailscale-account>Tailscale Account</a></li><li><a href=#docker-compose>Docker Compose</a></li><li><a href=#start-tailscale>Start Tailscale</a></li><li><a href=#testing>Testing</a></li><li><a href=#troubleshooting>Troubleshooting</a></li><li><a href=#resources>Resources</a></li></ul></nav></nav></aside></main><footer class=footer><span>&copy; 2023 knightsdata.com</span>
<span>Made with &#10084;&#65039; using <a target=_blank href=https://github.com/526avijitgupta/gokarna>Gokarna</a></span></footer></body></html>